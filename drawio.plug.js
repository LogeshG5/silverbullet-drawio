var K=Object.defineProperty;var l=(e,r)=>{for(var n in r)K(e,n,{get:r[n],enumerable:!0})};var g=e=>{throw new Error("Not initialized yet")},C=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var P=new Map,h=0;C&&(globalThis.syscall=async(e,...r)=>await new Promise((n,o)=>{h++,P.set(h,{resolve:n,reject:o}),g({type:"sys",id:h,name:e,args:r})}));function A(e,r,n){C&&(g=n,self.addEventListener("message",o=>{(async()=>{let i=o.data;switch(i.type){case"inv":{let a=e[i.name];if(!a)throw new Error(`Function not loaded: ${i.name}`);try{let s=await Promise.resolve(a(...i.args||[]));g({type:"invr",id:i.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",i.name,"error:",s.message),g({type:"invr",id:i.id,error:s.message})}}break;case"sysr":{let a=i.id,s=P.get(a);if(!s)throw Error("Invalid request id");P.delete(a),i.error?s.reject(new Error(i.error)):s.resolve(i.result)}break}})().catch(console.error)}),g({type:"manifest",manifest:r}))}function R(e){let r=atob(e),n=r.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=r.charCodeAt(i);return o}function v(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let r="",n=e.byteLength;for(let o=0;o<n;o++)r+=String.fromCharCode(e[o]);return btoa(r)}async function U(e,r){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),o=n.length>0?v(n):void 0;r={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,r)}globalThis.nativeFetch=globalThis.fetch;function V(){globalThis.fetch=async function(e,r){let n=r&&r.body?v(new Uint8Array(await new Response(r.body).arrayBuffer())):void 0,o=await U(e,r&&{method:r.method,headers:r.headers,base64Body:n});return new Response(o.base64Body?R(o.base64Body):null,{status:o.status,headers:o.headers})}}C&&V();var c={};l(c,{confirm:()=>me,copyToClipboard:()=>ve,deleteLine:()=>we,dispatch:()=>ue,downloadFile:()=>ee,filterBox:()=>ne,flashNotification:()=>te,fold:()=>ye,foldAll:()=>Ce,getCurrentPage:()=>k,getCursor:()=>X,getSelection:()=>E,getText:()=>M,getUiOption:()=>pe,goHistory:()=>_,hidePanel:()=>ie,insertAtCursor:()=>le,insertAtPos:()=>se,moveCursor:()=>ce,moveCursorToLine:()=>de,navigate:()=>z,newWindow:()=>$,openCommandPalette:()=>j,openPageNavigator:()=>H,openSearchPanel:()=>Ae,openUrl:()=>q,prompt:()=>ge,redo:()=>be,reloadConfigAndCommands:()=>Q,reloadPage:()=>D,reloadUI:()=>O,replaceRange:()=>ae,save:()=>J,setSelection:()=>L,setText:()=>Y,setUiOption:()=>fe,showPanel:()=>oe,toggleFold:()=>Pe,undo:()=>Ie,unfold:()=>he,unfoldAll:()=>xe,uploadFile:()=>re,vimEx:()=>Te});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function t(e,...r){return globalThis.syscall(e,...r)}function k(){return t("editor.getCurrentPage")}function M(){return t("editor.getText")}function Y(e,r=!1){return t("editor.setText",e,r)}function X(){return t("editor.getCursor")}function E(){return t("editor.getSelection")}function L(e,r){return t("editor.setSelection",e,r)}function J(){return t("editor.save")}function z(e,r=!1,n=!1){return t("editor.navigate",e,r,n)}function H(e="page"){return t("editor.openPageNavigator",e)}function j(){return t("editor.openCommandPalette")}function D(){return t("editor.reloadPage")}function O(){return t("editor.reloadUI")}function Q(){return t("editor.reloadConfigAndCommands")}function q(e,r=!1){return t("editor.openUrl",e,r)}function $(){return t("editor.newWindow")}function _(e){return t("editor.goHistory",e)}function ee(e,r){return t("editor.downloadFile",e,r)}function re(e,r){return t("editor.uploadFile",e,r)}function te(e,r="info"){return t("editor.flashNotification",e,r)}function ne(e,r,n="",o=""){return t("editor.filterBox",e,r,n,o)}function oe(e,r,n,o=""){return t("editor.showPanel",e,r,n,o)}function ie(e){return t("editor.hidePanel",e)}function se(e,r){return t("editor.insertAtPos",e,r)}function ae(e,r,n){return t("editor.replaceRange",e,r,n)}function ce(e,r=!1){return t("editor.moveCursor",e,r)}function de(e,r=1,n=!1){return t("editor.moveCursorToLine",e,r,n)}function le(e){return t("editor.insertAtCursor",e)}function ue(e){return t("editor.dispatch",e)}function ge(e,r=""){return t("editor.prompt",e,r)}function me(e){return t("editor.confirm",e)}function pe(e){return t("editor.getUiOption",e)}function fe(e,r){return t("editor.setUiOption",e,r)}function ye(){return t("editor.fold")}function he(){return t("editor.unfold")}function Pe(){return t("editor.toggleFold")}function Ce(){return t("editor.foldAll")}function xe(){return t("editor.unfoldAll")}function Ie(){return t("editor.undo")}function be(){return t("editor.redo")}function Ae(){return t("editor.openSearchPanel")}function ve(e){return t("editor.copyToClipboard",e)}function we(){return t("editor.deleteLine")}function Te(e){return t("editor.vimEx",e)}var m={};l(m,{parseMarkdown:()=>Ze,renderParseTree:()=>Se});function Ze(e){return t("markdown.parseMarkdown",e)}function Se(e){return t("markdown.renderParseTree",e)}var u={};l(u,{deleteAttachment:()=>Me,deleteFile:()=>Je,deletePage:()=>Be,fileExists:()=>ze,getAttachmentMeta:()=>Ue,getFileMeta:()=>Ee,getPageMeta:()=>Ne,listAttachments:()=>Re,listFiles:()=>Ye,listPages:()=>Ge,listPlugs:()=>Ke,readAttachment:()=>Ve,readFile:()=>Xe,readPage:()=>We,writeAttachment:()=>ke,writeFile:()=>Le,writePage:()=>Fe});function Ge(){return t("space.listPages")}function Ne(e){return t("space.getPageMeta",e)}function We(e){return t("space.readPage",e)}function Fe(e,r){return t("space.writePage",e,r)}function Be(e){return t("space.deletePage",e)}function Ke(){return t("space.listPlugs")}function Re(){return t("space.listAttachments")}function Ue(e){return t("space.getAttachmentMeta",e)}function Ve(e){return t("space.readAttachment",e)}function ke(e,r){return t("space.writeAttachment",e,r)}function Me(e){return t("space.deleteAttachment",e)}function Ye(){return t("space.listFiles")}function Xe(e){return t("space.readFile",e)}function Ee(e){return t("space.getFileMeta",e)}function Le(e,r){return t("space.writeFile",e,r)}function Je(e){return t("space.deleteFile",e)}function ze(e){return t("space.fileExists",e)}var p={};l(p,{applyAttributeExtractors:()=>qe,getEnv:()=>rr,getMode:()=>tr,getSpaceConfig:()=>$e,getVersion:()=>nr,invokeCommand:()=>je,invokeFunction:()=>He,invokeSpaceFunction:()=>Qe,listCommands:()=>De,listSyscalls:()=>Oe,reloadConfig:()=>er,reloadPlugs:()=>_e});function He(e,...r){return t("system.invokeFunction",e,...r)}function je(e,r){return t("system.invokeCommand",e,r)}function De(){return t("system.listCommands")}function Oe(){return t("system.listSyscalls")}function Qe(e,...r){return t("system.invokeSpaceFunction",e,...r)}function qe(e,r,n){return t("system.applyAttributeExtractors",e,r,n)}async function $e(e,r){return await t("system.getSpaceConfig",e)??r}function _e(){return t("system.reloadPlugs")}function er(){return t("system.reloadConfig")}function rr(){return t("system.getEnv")}function tr(){return t("system.getMode")}function nr(){return t("system.getVersion")}var f={};l(f,{readAsset:()=>ur});function lr(e){let r=atob(e),n=r.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=r.charCodeAt(i);return o}function w(e){let r=e.split(",",2)[1];return lr(r)}async function ur(e,r,n="utf8"){let o=await t("asset.readAsset",e,r);switch(n){case"utf8":return new TextDecoder().decode(w(o));case"dataurl":return o}}var y={};l(y,{parse:()=>pr,stringify:()=>fr});function pr(e){return t("yaml.parse",e)}function fr(e){return t("yaml.stringify",e)}function x(e,r){if(r(e))return[e];let n=[];if(e.children)for(let o of e.children)n=[...n,...x(o,r)];return n}function I(e,r){return x(e,n=>n.type===r)[0]}function T(e,r){x(e,r)}async function xr(e,r){let n=await u.readPage(e),o=await m.parseMarkdown(n),i;return T(o,a=>{if(a.type!=="FencedCode")return!1;let s=I(a,"CodeInfo");if(r&&!s||r&&!r.includes(s.children[0].text))return!1;let d=I(a,"CodeText");return d?(i=d.children[0].text,!0):!1}),i}async function Z(e,r=["yaml"]){let n=await xr(e,r);if(n!==void 0)try{return y.parse(n)}catch(o){throw console.error("YAML Page parser error",o),new Error(`YAML Error: ${o.message}`)}}async function S(e,r){try{return await p.getSpaceConfig(e)??r}catch{try{let o=(await Z("SETTINGS")||{})[e];return o===void 0?r:o}catch(n){if(n.message==="Not found")return r;throw n}}}async function Ir(e,r,n){let o=await f.readAsset("drawio","assets/drawioframe.js");c.showPanel("modal",1,`
      <style type="text/css">
        iframe {
          border: 0;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          width: 100%;
          height: 100%
        }
      </style>
      <div>
        <div id="drawiodata">${n}</div>
        <iframe id="draioiframe" src=${e} drawio-path='${r}'></iframe>
      </div>
    `,`${o}`)}function br(e){let r=/\((.*?)\)/g,n=[],o;for(;(o=r.exec(e))!==null;)n.push(o[1]);return n}async function G(){let e=await c.getText(),r=await c.getCurrentPage(),n=r.substring(0,r.lastIndexOf("/")),o=br(e),i="";if(o.length==0){c.flashNotification("No diagrams found");return}if(o.length==1)i=n+"/"+o[0];else{let F=o.map(B=>({name:B,description:""})),b=await c.filterBox("Edit",F,"","");if(!b){await c.flashNotification("No diagram selected.","error");return}i=n+"/"+b.name}var a=await u.readAttachment(i);a=String.fromCharCode.apply(null,a);let s=await S("drawio"),d="";s&&s.editorUrl?d=s.editorUrl:d="https://embed.diagrams.net/?embed=1&spin=1&proto=json&configure=1",await Ir(d,i,a)}var N={editdrawio:G},W={name:"drawio",version:.1,assets:{"assets/drawioframe.js":{data:"data:application/javascript;base64,dmFyIGlmcmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkcmFpb2lmcmFtZScpCmlmcmFtZS5zZXRBdHRyaWJ1dGUoJ2ZyYW1lYm9yZGVyJywgJzAnKTsKCnZhciBjbG9zZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgcmVjZWl2ZSk7CiAgICBhd2FpdCBzeXNjYWxsKCJlZGl0b3IuaGlkZVBhbmVsIiwgIm1vZGFsIik7Cn07Cgp2YXIgcmVjZWl2ZSA9IGFzeW5jIGZ1bmN0aW9uIChldnQpIHsKICAgIGlmIChldnQuZGF0YS5sZW5ndGggPCAxKSByZXR1cm47CiAgICB2YXIgbXNnID0gSlNPTi5wYXJzZShldnQuZGF0YSk7CgogICAgLy8gSWYgY29uZmlndXJlPTEgVVJMIHBhcmFtZXRlciBpcyB1c2VkIHRoZSBhcHBsaWNhdGlvbgogICAgLy8gd2FpdHMgZm9yIHRoaXMgbWVzc2FnZS4gRm9yIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBzZWUKICAgIC8vIGh0dHBzOi8vZGVzay5kcmF3LmlvL3N1cHBvcnQvc29sdXRpb25zL2FydGljbGVzLzE2MDAwMDU4MzE2CiAgICBpZiAobXNnLmV2ZW50ID09ICdjb25maWd1cmUnKSB7CiAgICAgICAgLy8gQ29uZmlndXJhdGlvbiBleGFtcGxlCiAgICAgICAgaWZyYW1lLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICBhY3Rpb246ICdjb25maWd1cmUnLAogICAgICAgICAgICBjb25maWc6IHsgZGVmYXVsdEZvbnRzOiBbIkh1bW9yIFNhbnMiLCAiSGVsdmV0aWNhIiwgIlRpbWVzIE5ldyBSb21hbiJdIH0KICAgICAgICB9KSwgJyonKTsKICAgIH0KICAgIGVsc2UgaWYgKG1zZy5ldmVudCA9PSAnaW5pdCcpIHsKICAgICAgICAvLyBBdm9pZHMgdW5lc2NhcGVkIDwgYW5kID4gZnJvbSBpbm5lckhUTUwgZm9yIHZhbGlkIFhNTAogICAgICAgIGNvbnN0IGRhdGEgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZHJhd2lvZGF0YScpOwogICAgICAgIGNvbnN0IHN2Z2VsZSA9IGRhdGEuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3N2ZycpWzBdOwogICAgICAgIGNvbnN0IHN2ZyA9IG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoc3ZnZWxlKTsKICAgICAgICAvLyBjb25zb2xlLmxvZygiRGF0YSIsIGRhdGEpOwogICAgICAgIC8vIGNvbnNvbGUubG9nKCJzdmdlbGUiLCBzdmdlbGUpOwogICAgICAgIC8vIGNvbnNvbGUubG9nKCJzdmciLCBzdmcpOwogICAgICAgIC8vIGNvbnN0IHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICAvLyBjb25zdCBkb2MgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKGlmcmFtZS5nZXRBdHRyaWJ1dGUoJ2RyYXdpby1kYXRhJyksICd0ZXh0L2h0bWwnKTsKICAgICAgICAvLyBjb25zb2xlLmxvZygiRE9DIiwgZG9jKTsKICAgICAgICAvLyBjb25zb2xlLmxvZygiZG9jIFNWRyIsIGRvYy5xdWVyeVNlbGVjdG9yKCdzdmcnKSkKICAgICAgICAvLyBjb25zdCBzdmdlID0gbmV3IFhNTFNlcmlhbGl6ZXIoKS5zZXJpYWxpemVUb1N0cmluZyhkb2MucXVlcnlTZWxlY3Rvcignc3ZnJykpOwogICAgICAgIC8vIGNvbnNvbGUubG9nKCJkb2MgU1ZHZSIsIHN2Z2UpOwoKICAgICAgICBpZnJhbWUuY29udGVudFdpbmRvdy5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGFjdGlvbjogJ2xvYWQnLAogICAgICAgICAgICBhdXRvc2F2ZTogMSwKICAgICAgICAgICAgeG1sOiBzdmcKICAgICAgICB9KSwgJyonKTsKCiAgICB9CiAgICBlbHNlIGlmIChtc2cuZXZlbnQgPT0gJ2V4cG9ydCcpIHsKICAgICAgICAvLyBFeHRyYWN0cyBTVkcgRE9NIGZyb20gZGF0YSBVUkkgdG8gZW5hYmxlIGxpbmtzCiAgICAgICAgY29uc3Qgc3ZnID0gYXRvYihtc2cuZGF0YS5zdWJzdHJpbmcobXNnLmRhdGEuaW5kZXhPZignLCcpICsgMSkpOwogICAgICAgIGNvbnN0IHN2Z2UgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoc3ZnKQogICAgICAgIC8vIGRpYWdyYW1QYXRoID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RyYXdpb1BhdGgnKS5pbm5lckhUTUw7CiAgICAgICAgZGlhZ3JhbVBhdGggPSBpZnJhbWUuZ2V0QXR0cmlidXRlKCdkcmF3aW8tcGF0aCcpOwogICAgICAgIGF3YWl0IHN5c2NhbGwoInNwYWNlLndyaXRlRmlsZSIsIGRpYWdyYW1QYXRoLCBzdmdlKTsKICAgICAgICBhd2FpdCBzeXNjYWxsKCJlZGl0b3IucmVsb2FkUGFnZSIpOyAvL25vdCB3b3JraW5nCiAgICAgICAgY2xvc2UoKTsKICAgIH0KICAgIGVsc2UgaWYgKG1zZy5ldmVudCA9PSAnYXV0b3NhdmUnKSB7CiAgICB9CiAgICBlbHNlIGlmIChtc2cuZXZlbnQgPT0gJ3NhdmUnKSB7CiAgICAgICAgLy8gQ2FsbCBleHBvcnQKICAgICAgICBpZnJhbWUuY29udGVudFdpbmRvdy5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGFjdGlvbjogJ2V4cG9ydCcsCiAgICAgICAgICAgIGZvcm1hdDogJ3htbHN2ZycsIHhtbDogbXNnLnhtbCwgc3BpbjogJ1VwZGF0aW5nIHBhZ2UnCiAgICAgICAgfSksICcqJyk7CiAgICB9CiAgICBlbHNlIGlmIChtc2cuZXZlbnQgPT0gJ2V4aXQnKSB7CiAgICAgICAgY2xvc2UoKTsKICAgIH0KCn07Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIHJlY2VpdmUpOw==",mtime:1736667475660}},imports:["https://get.silverbullet.md/global.plug.json"],requiredPermissions:["shell","fetch"],functions:{editdrawio:{path:"./drawio.ts:edit",command:{name:"Draw.io: Edit diagram",requireMode:"r"}}}},ct={manifest:W,functionMapping:N};A(N,W,self.postMessage);export{ct as plug};
