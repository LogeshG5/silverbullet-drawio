var V=Object.defineProperty;var l=(e,t)=>{for(var n in t)V(e,n,{get:t[n],enumerable:!0})};var u=e=>{throw new Error("Not initialized yet")},C=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var x=new Map,P=0;C&&(globalThis.syscall=async(e,...t)=>await new Promise((n,o)=>{P++,x.set(P,{resolve:n,reject:o}),u({type:"sys",id:P,name:e,args:t})}));function v(e,t,n){C&&(u=n,self.addEventListener("message",o=>{(async()=>{let i=o.data;switch(i.type){case"inv":{let a=e[i.name];if(!a)throw new Error(`Function not loaded: ${i.name}`);try{let s=await Promise.resolve(a(...i.args||[]));u({type:"invr",id:i.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",i.name,"error:",s.message),u({type:"invr",id:i.id,error:s.message})}}break;case"sysr":{let a=i.id,s=x.get(a);if(!s)throw Error("Invalid request id");x.delete(a),i.error?s.reject(new Error(i.error)):s.resolve(i.result)}break}})().catch(console.error)}),u({type:"manifest",manifest:t}))}function k(e){let t=atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o}function w(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",n=e.byteLength;for(let o=0;o<n;o++)t+=String.fromCharCode(e[o]);return btoa(t)}async function Y(e,t){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),o=n.length>0?w(n):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function M(){globalThis.fetch=async function(e,t){let n=t&&t.body?w(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await Y(e,t&&{method:t.method,headers:t.headers,base64Body:n});return new Response(o.base64Body?k(o.base64Body):null,{status:o.status,headers:o.headers})}}C&&M();var c={};l(c,{confirm:()=>fe,copyToClipboard:()=>Te,deleteLine:()=>Ze,dispatch:()=>me,downloadFile:()=>re,filterBox:()=>ie,flashNotification:()=>oe,fold:()=>Pe,foldAll:()=>Ie,getCurrentPage:()=>U,getCursor:()=>H,getSelection:()=>L,getText:()=>E,getUiOption:()=>ye,goHistory:()=>te,hidePanel:()=>ae,insertAtCursor:()=>ue,insertAtPos:()=>ce,moveCursor:()=>le,moveCursorToLine:()=>ge,navigate:()=>J,newWindow:()=>ee,openCommandPalette:()=>O,openPageNavigator:()=>j,openSearchPanel:()=>we,openUrl:()=>_,prompt:()=>pe,redo:()=>ve,reloadConfigAndCommands:()=>$,reloadPage:()=>Q,reloadUI:()=>q,replaceRange:()=>de,save:()=>D,setSelection:()=>z,setText:()=>X,setUiOption:()=>he,showPanel:()=>se,toggleFold:()=>Ce,undo:()=>be,unfold:()=>xe,unfoldAll:()=>Ae,uploadFile:()=>ne,vimEx:()=>Se});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function U(){return r("editor.getCurrentPage")}function E(){return r("editor.getText")}function X(e,t=!1){return r("editor.setText",e,t)}function H(){return r("editor.getCursor")}function L(){return r("editor.getSelection")}function z(e,t){return r("editor.setSelection",e,t)}function D(){return r("editor.save")}function J(e,t=!1,n=!1){return r("editor.navigate",e,t,n)}function j(e="page"){return r("editor.openPageNavigator",e)}function O(){return r("editor.openCommandPalette")}function Q(){return r("editor.reloadPage")}function q(){return r("editor.reloadUI")}function $(){return r("editor.reloadConfigAndCommands")}function _(e,t=!1){return r("editor.openUrl",e,t)}function ee(){return r("editor.newWindow")}function te(e){return r("editor.goHistory",e)}function re(e,t){return r("editor.downloadFile",e,t)}function ne(e,t){return r("editor.uploadFile",e,t)}function oe(e,t="info"){return r("editor.flashNotification",e,t)}function ie(e,t,n="",o=""){return r("editor.filterBox",e,t,n,o)}function se(e,t,n,o=""){return r("editor.showPanel",e,t,n,o)}function ae(e){return r("editor.hidePanel",e)}function ce(e,t){return r("editor.insertAtPos",e,t)}function de(e,t,n){return r("editor.replaceRange",e,t,n)}function le(e,t=!1){return r("editor.moveCursor",e,t)}function ge(e,t=1,n=!1){return r("editor.moveCursorToLine",e,t,n)}function ue(e){return r("editor.insertAtCursor",e)}function me(e){return r("editor.dispatch",e)}function pe(e,t=""){return r("editor.prompt",e,t)}function fe(e){return r("editor.confirm",e)}function ye(e){return r("editor.getUiOption",e)}function he(e,t){return r("editor.setUiOption",e,t)}function Pe(){return r("editor.fold")}function xe(){return r("editor.unfold")}function Ce(){return r("editor.toggleFold")}function Ie(){return r("editor.foldAll")}function Ae(){return r("editor.unfoldAll")}function be(){return r("editor.undo")}function ve(){return r("editor.redo")}function we(){return r("editor.openSearchPanel")}function Te(e){return r("editor.copyToClipboard",e)}function Ze(){return r("editor.deleteLine")}function Se(e){return r("editor.vimEx",e)}var m={};l(m,{parseMarkdown:()=>Ge,renderParseTree:()=>We});function Ge(e){return r("markdown.parseMarkdown",e)}function We(e){return r("markdown.renderParseTree",e)}var g={};l(g,{deleteAttachment:()=>Ee,deleteFile:()=>De,deletePage:()=>Ne,fileExists:()=>Je,getAttachmentMeta:()=>Ye,getFileMeta:()=>Le,getPageMeta:()=>Re,listAttachments:()=>ke,listFiles:()=>Xe,listPages:()=>Fe,listPlugs:()=>Ve,readAttachment:()=>Me,readFile:()=>He,readPage:()=>Ke,writeAttachment:()=>Ue,writeFile:()=>ze,writePage:()=>Be});function Fe(){return r("space.listPages")}function Re(e){return r("space.getPageMeta",e)}function Ke(e){return r("space.readPage",e)}function Be(e,t){return r("space.writePage",e,t)}function Ne(e){return r("space.deletePage",e)}function Ve(){return r("space.listPlugs")}function ke(){return r("space.listAttachments")}function Ye(e){return r("space.getAttachmentMeta",e)}function Me(e){return r("space.readAttachment",e)}function Ue(e,t){return r("space.writeAttachment",e,t)}function Ee(e){return r("space.deleteAttachment",e)}function Xe(){return r("space.listFiles")}function He(e){return r("space.readFile",e)}function Le(e){return r("space.getFileMeta",e)}function ze(e,t){return r("space.writeFile",e,t)}function De(e){return r("space.deleteFile",e)}function Je(e){return r("space.fileExists",e)}var p={};l(p,{applyAttributeExtractors:()=>_e,getEnv:()=>nt,getMode:()=>ot,getSpaceConfig:()=>et,getVersion:()=>it,invokeCommand:()=>Oe,invokeFunction:()=>je,invokeSpaceFunction:()=>$e,listCommands:()=>Qe,listSyscalls:()=>qe,reloadConfig:()=>rt,reloadPlugs:()=>tt});function je(e,...t){return r("system.invokeFunction",e,...t)}function Oe(e,t){return r("system.invokeCommand",e,t)}function Qe(){return r("system.listCommands")}function qe(){return r("system.listSyscalls")}function $e(e,...t){return r("system.invokeSpaceFunction",e,...t)}function _e(e,t,n){return r("system.applyAttributeExtractors",e,t,n)}async function et(e,t){return await r("system.getSpaceConfig",e)??t}function tt(){return r("system.reloadPlugs")}function rt(){return r("system.reloadConfig")}function nt(){return r("system.getEnv")}function ot(){return r("system.getMode")}function it(){return r("system.getVersion")}var f={};l(f,{readAsset:()=>mt});function ut(e){let t=atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o}function T(e){let t=e.split(",",2)[1];return ut(t)}async function mt(e,t,n="utf8"){let o=await r("asset.readAsset",e,t);switch(n){case"utf8":return new TextDecoder().decode(T(o));case"dataurl":return o}}var y={};l(y,{parse:()=>yt,stringify:()=>ht});function yt(e){return r("yaml.parse",e)}function ht(e){return r("yaml.stringify",e)}function I(e,t){if(t(e))return[e];let n=[];if(e.children)for(let o of e.children)n=[...n,...I(o,t)];return n}function A(e,t){return I(e,n=>n.type===t)[0]}function Z(e,t){I(e,t)}async function At(e,t){let n=await g.readPage(e),o=await m.parseMarkdown(n),i;return Z(o,a=>{if(a.type!=="FencedCode")return!1;let s=A(a,"CodeInfo");if(t&&!s||t&&!t.includes(s.children[0].text))return!1;let d=A(a,"CodeText");return d?(i=d.children[0].text,!0):!1}),i}async function S(e,t=["yaml"]){let n=await At(e,t);if(n!==void 0)try{return y.parse(n)}catch(o){throw console.error("YAML Page parser error",o),new Error(`YAML Error: ${o.message}`)}}async function G(e,t){try{return await p.getSpaceConfig(e)??t}catch{try{let o=(await S("SETTINGS")||{})[e];return o===void 0?t:o}catch(n){if(n.message==="Not found")return t;throw n}}}function W(e){let t=e.lastIndexOf(".");return t!==-1?e.slice(t+1):""}async function bt(e){let t=new DataView(e.buffer),n=`\x89PNG\r

`;for(let i=0;i<n.length;i++)if(String.fromCharCode(t.getUint8(i))!==n[i])throw new Error("Invalid PNG file.");let o=8;for(;o<t.byteLength;){let i=t.getUint32(o);if(String.fromCharCode(t.getUint8(o+4),t.getUint8(o+5),t.getUint8(o+6),t.getUint8(o+7))==="tEXt"){let s=e.slice(o+8,o+8+i);return new TextDecoder().decode(s)}o+=12+i}throw new Error("No Draw.io metadata found in the PNG.")}async function vt(e,t,n){let o=await f.readAsset("drawio","assets/drawioframe.js");c.showPanel("modal",1,`
      <style type="text/css">
        iframe {
          border: 0;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          width: 100%;
          height: 100%
        }
      </style>
      <div>
        <div id="drawiodata">${n}</div>
        <iframe id="draioiframe" src=${e} drawio-path='${t}'></iframe>
      </div>
    `,`${o}`)}function wt(e){let t=/\((.*?)\)/g,n=[],o;for(;(o=t.exec(e))!==null;){let i=W(o[1]);(i=="svg"||i=="png")&&n.push(o[1])}return n}async function F(){let e=await c.getText(),t=await c.getCurrentPage(),n=t.substring(0,t.lastIndexOf("/")),o=wt(e),i="";if(o.length==0){c.flashNotification("No diagrams found");return}if(o.length==1)i=n+"/"+o[0];else{let B=o.map(N=>({name:N,description:""})),b=await c.filterBox("Edit",B,"","");if(!b){await c.flashNotification("No diagram selected.","error");return}i=n+"/"+b.name}let a=W(i);var s=await g.readAttachment(i);a=="png"?s=await bt(s):a=="svg"&&(s=String.fromCharCode.apply(null,s)),console.log("DD ",s);let d=await G("drawio"),h="";d&&d.editorUrl?h=d.editorUrl:h="https://embed.diagrams.net/?embed=1&spin=1&proto=json&configure=1",await vt(h,i,s)}var R={editdrawio:F},K={name:"drawio",version:.1,assets:{"assets/drawioframe.js":{data:"data:application/javascript;base64,dmFyIGlmcmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkcmFpb2lmcmFtZScpCmlmcmFtZS5zZXRBdHRyaWJ1dGUoJ2ZyYW1lYm9yZGVyJywgJzAnKTsKCnZhciBjbG9zZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgcmVjZWl2ZSk7CiAgICBhd2FpdCBzeXNjYWxsKCJlZGl0b3IuaGlkZVBhbmVsIiwgIm1vZGFsIik7Cn07Cgp2YXIgcmVjZWl2ZSA9IGFzeW5jIGZ1bmN0aW9uIChldnQpIHsKICAgIGlmIChldnQuZGF0YS5sZW5ndGggPCAxKSByZXR1cm47CiAgICB2YXIgbXNnID0gSlNPTi5wYXJzZShldnQuZGF0YSk7CgogICAgLy8gSWYgY29uZmlndXJlPTEgVVJMIHBhcmFtZXRlciBpcyB1c2VkIHRoZSBhcHBsaWNhdGlvbgogICAgLy8gd2FpdHMgZm9yIHRoaXMgbWVzc2FnZS4gRm9yIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBzZWUKICAgIC8vIGh0dHBzOi8vZGVzay5kcmF3LmlvL3N1cHBvcnQvc29sdXRpb25zL2FydGljbGVzLzE2MDAwMDU4MzE2CiAgICBpZiAobXNnLmV2ZW50ID09ICdjb25maWd1cmUnKSB7CiAgICAgICAgLy8gQ29uZmlndXJhdGlvbiBleGFtcGxlCiAgICAgICAgaWZyYW1lLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICBhY3Rpb246ICdjb25maWd1cmUnLAogICAgICAgICAgICBjb25maWc6IHsgZGVmYXVsdEZvbnRzOiBbIkh1bW9yIFNhbnMiLCAiSGVsdmV0aWNhIiwgIlRpbWVzIE5ldyBSb21hbiJdIH0KICAgICAgICB9KSwgJyonKTsKICAgIH0KICAgIGVsc2UgaWYgKG1zZy5ldmVudCA9PSAnaW5pdCcpIHsKICAgICAgICAvLyBBdm9pZHMgdW5lc2NhcGVkIDwgYW5kID4gZnJvbSBpbm5lckhUTUwgZm9yIHZhbGlkIFhNTAogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gaWZyYW1lLmdldEF0dHJpYnV0ZSgnZHJhd2lvLXBhdGgnKTsKICAgICAgICBjb25zdCBpbmRleCA9IGZpbGVuYW1lLmxhc3RJbmRleE9mKCcuJyk7CiAgICAgICAgY29uc3QgZXh0ID0gaW5kZXggIT09IC0xID8gZmlsZW5hbWUuc2xpY2UoaW5kZXggKyAxKSA6ICcnOwogICAgICAgIGNvbnN0IGRhdGFEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZHJhd2lvZGF0YScpOwogICAgICAgIGxldCBkYXRhID0gIiI7CiAgICAgICAgaWYgKGV4dCA9PSAnc3ZnJykgewogICAgICAgICAgICBjb25zdCBzdmdlbGUgPSBkYXRhRGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzdmcnKVswXTsKICAgICAgICAgICAgZGF0YSA9IG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoc3ZnZWxlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGRhdGEgPSBkYXRhRGl2OwogICAgICAgIH0KICAgICAgICBpZnJhbWUuY29udGVudFdpbmRvdy5wb3N0TWVzc2FnZShKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGFjdGlvbjogJ2xvYWQnLAogICAgICAgICAgICBhdXRvc2F2ZTogMSwKICAgICAgICAgICAgeG1sOiBkYXRhCiAgICAgICAgfSksICcqJyk7CgogICAgfQogICAgZWxzZSBpZiAobXNnLmV2ZW50ID09ICdleHBvcnQnKSB7CiAgICAgICAgLy8gRXh0cmFjdHMgU1ZHIERPTSBmcm9tIGRhdGEgVVJJIHRvIGVuYWJsZSBsaW5rcwogICAgICAgIGNvbnN0IHN2ZyA9IGF0b2IobXNnLmRhdGEuc3Vic3RyaW5nKG1zZy5kYXRhLmluZGV4T2YoJywnKSArIDEpKTsKICAgICAgICBjb25zdCBzdmdlID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHN2ZykKICAgICAgICBkaWFncmFtUGF0aCA9IGlmcmFtZS5nZXRBdHRyaWJ1dGUoJ2RyYXdpby1wYXRoJyk7CiAgICAgICAgYXdhaXQgc3lzY2FsbCgic3BhY2Uud3JpdGVGaWxlIiwgZGlhZ3JhbVBhdGgsIHN2Z2UpOwogICAgICAgIGF3YWl0IHN5c2NhbGwoImVkaXRvci5yZWxvYWRQYWdlIik7IC8vbm90IHdvcmtpbmcKICAgICAgICBjbG9zZSgpOwogICAgfQogICAgZWxzZSBpZiAobXNnLmV2ZW50ID09ICdhdXRvc2F2ZScpIHsKICAgIH0KICAgIGVsc2UgaWYgKG1zZy5ldmVudCA9PSAnc2F2ZScpIHsKICAgICAgICAvLyBDYWxsIGV4cG9ydAogICAgICAgIGlmcmFtZS5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgYWN0aW9uOiAnZXhwb3J0JywKICAgICAgICAgICAgZm9ybWF0OiAneG1sc3ZnJywgeG1sOiBtc2cueG1sLCBzcGluOiAnVXBkYXRpbmcgcGFnZScKICAgICAgICB9KSwgJyonKTsKICAgIH0KICAgIGVsc2UgaWYgKG1zZy5ldmVudCA9PSAnZXhpdCcpIHsKICAgICAgICBjbG9zZSgpOwogICAgfQoKfTsKCndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgcmVjZWl2ZSk7",mtime:1736674143979}},imports:["https://get.silverbullet.md/global.plug.json"],requiredPermissions:["shell","fetch"],functions:{editdrawio:{path:"./drawio.ts:edit",command:{name:"Draw.io: Edit diagram",requireMode:"r"}}}},gr={manifest:K,functionMapping:R};v(R,K,self.postMessage);export{gr as plug};
